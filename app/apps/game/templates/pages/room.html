{% extends "base.html" %}

{% block title %}房间大厅 - 图灵测试{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
  <div class="max-w-4xl mx-auto">
    <!-- 房间信息 -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-white">房间大厅</h1>
          <p class="text-purple-200">房间号：<span class="font-mono text-lg">{{ room.room_id }}</span></p>
        </div>
        <div class="text-right">
          <p class="text-purple-200">状态：<span id="room-phase" class="text-white">{{ room.phase }}</span></p>
          <p class="text-purple-200">回合：<span id="room-current-round">{{ room.current_round }}</span>/<span id="room-total-rounds">{{ room.total_rounds }}</span></p>
        </div>
      </div>

      <!-- 邀请链接 -->
      <div class="mt-4 pt-4 border-t border-white/10">
        <div class="flex items-center gap-2">
          <span class="text-purple-200 text-sm whitespace-nowrap">邀请链接：</span>
          <div class="flex-1 flex items-center gap-2">
            <input type="text" id="invite-link" value="{{ invite_link }}" readonly
              class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm font-mono" />
            <button onclick="copyInviteLink()"
              class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm font-medium rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all whitespace-nowrap">
              <i class="fa-solid fa-copy mr-1"></i>复制
            </button>
          </div>
        </div>
        <p class="text-purple-300 text-xs mt-2">复制链接分享给好友，好友点击即可快速加入房间</p>
      </div>

      <div class="mt-4 pt-4 border-t border-white/10">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-sm text-purple-200">附加给分机制</p>
            <p id="bonus-scoring-desc" class="text-xs text-purple-300">
              {% if room.config.bonus_scoring_enabled %}
              已开启：提问者/被测者满足条件可获得额外加分
              {% else %}
              未开启：仅按投票结果计分
              {% endif %}
            </p>
          </div>
          <span
            id="bonus-scoring-status"
            class="inline-flex items-center rounded-full px-3 py-1 text-sm {% if room.config.bonus_scoring_enabled %}bg-green-500/20 text-green-300{% else %}bg-slate-500/20 text-slate-300{% endif %}"
          >
            {% if room.config.bonus_scoring_enabled %}已开启{% else %}未开启{% endif %}
          </span>
        </div>

        {% if current_player and current_player.is_owner %}
        <form
          id="bonus-scoring-form"
          class="mt-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
          hx-post="/game/{{ room.id }}/bonus-scoring"
          hx-target="#bonus-scoring-result"
        >
          <label class="inline-flex items-center gap-2 text-sm text-purple-100">
            <input
              id="bonus-scoring-toggle"
              type="checkbox"
              name="bonus_scoring_enabled"
              value="true"
              class="h-4 w-4 rounded border-white/20 bg-white/10 text-purple-500 focus:ring-purple-400"
              {% if room.config.bonus_scoring_enabled %}checked{% endif %}
            />
            开启附加给分机制
          </label>
          <button type="submit" class="btn-primary sm:w-auto">保存给分设置</button>
        </form>
        <div id="bonus-scoring-result" class="mt-2 text-sm"></div>
        {% endif %}
      </div>
    </div>

    <!-- 玩家列表 -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6">
      <h2 class="text-xl font-semibold text-white mb-4">
        玩家列表 (<span id="player-count">{{ players|length }}</span>/{{ room.config.max_players }})
      </h2>
      {% include "partials/room_player_list.html" %}
    </div>

    <!-- 操作按钮 -->
    <div class="flex gap-4">
      {% if current_player %}
      <button
        id="ready-btn"
        class="flex-1 btn-primary bg-gradient-to-r from-purple-500 to-pink-500"
        hx-post="/game/{{ room.id }}/ready"
        hx-vals='{"is_ready": "{{ "false" if current_player and current_player.is_ready else "true" }}"}'
        hx-target="#ready-result"
      >
        {% if current_player and current_player.is_ready %}取消准备{% else %}准备{% endif %}
      </button>
      {% endif %}
      {% if current_player and current_player.is_owner %}
      <button
        id="start-btn"
        class="flex-1 btn-primary opacity-50 cursor-not-allowed"
        hx-post="/game/{{ room.id }}/start"
        hx-target="#start-result"
        disabled
      >
        开始游戏
      </button>
      {% endif %}
      <button
        class="px-6 btn-ghost text-red-400"
        hx-post="/game/{{ room.id }}/leave"
        hx-confirm="确定要离开房间吗？"
        hx-target="body"
      >
        离开
      </button>
    </div>
    {% if not current_player %}
    <p class="mt-3 text-sm text-red-300">你不在该房间中，请返回首页重新加入房间。</p>
    {% endif %}

    <div id="ready-result" class="mt-4"></div>
    <div id="start-result" class="mt-4"></div>
    <div id="kick-result" class="mt-4"></div>
  </div>
</div>

<script>
// 复制邀请链接
function copyInviteLink() {
  const input = document.getElementById('invite-link');
  input.select();
  input.setSelectionRange(0, 99999); // 移动端兼容

  if (navigator.clipboard && window.isSecureContext) {
    // 使用现代 Clipboard API
    navigator.clipboard.writeText(input.value).then(() => {
      showCopyToast('链接已复制！');
    }).catch(() => {
      // 降级方案
      fallbackCopy(input);
    });
  } else {
    // 降级方案
    fallbackCopy(input);
  }
}

function fallbackCopy(input) {
  try {
    document.execCommand('copy');
    showCopyToast('链接已复制！');
  } catch (err) {
    showCopyToast('复制失败，请手动复制');
  }
}

function showCopyToast(message) {
  // 创建提示元素
  const toast = document.createElement('div');
  toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
  toast.textContent = message;
  document.body.appendChild(toast);

  // 2秒后移除
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

// 等待 HTMX 加载完成
document.addEventListener('DOMContentLoaded', () => {
  const roomId = '{{ room.id }}';
  console.log('Room ID:', roomId);

  // 获取当前玩家 ID（从 Cookie 中读取）
  function getCurrentPlayerId() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'player_id') {
        return value;
      }
    }
    return null;
  }

  // 更新准备按钮状态和开始按钮可用性
  window.updateReadyButtonState = function() {
    const readyBtn = document.getElementById('ready-btn');
    const startBtn = document.getElementById('start-btn');
    const playerCountEl = document.getElementById('player-count');
    const phaseEl = document.getElementById('room-phase');
    const currentRoundEl = document.getElementById('room-current-round');
    const totalRoundEl = document.getElementById('room-total-rounds');
    const bonusStatusEl = document.getElementById('bonus-scoring-status');
    const bonusDescEl = document.getElementById('bonus-scoring-desc');
    const bonusToggleEl = document.getElementById('bonus-scoring-toggle');
    const currentPlayerId = getCurrentPlayerId();

    if (!currentPlayerId && !playerCountEl && !phaseEl && !currentRoundEl && !totalRoundEl) return;

    // 通过 fetch 获取房间状态
    fetch(`/game/api/${roomId}/state`)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.players) {
          if (phaseEl && data.room?.phase) {
            phaseEl.textContent = String(data.room.phase);
          }
          if (currentRoundEl && data.room?.current_round !== undefined) {
            currentRoundEl.textContent = String(data.room.current_round);
          }
          if (totalRoundEl) {
            const totalRounds = data.room?.total_rounds ?? data.room?.config?.rounds_per_game;
            if (totalRounds !== undefined) {
              totalRoundEl.textContent = String(totalRounds);
            }
          }
          const bonusScoringEnabled = Boolean(data.room?.config?.bonus_scoring_enabled);
          if (bonusStatusEl) {
            bonusStatusEl.textContent = bonusScoringEnabled ? '已开启' : '未开启';
            bonusStatusEl.classList.toggle('bg-green-500/20', bonusScoringEnabled);
            bonusStatusEl.classList.toggle('text-green-300', bonusScoringEnabled);
            bonusStatusEl.classList.toggle('bg-slate-500/20', !bonusScoringEnabled);
            bonusStatusEl.classList.toggle('text-slate-300', !bonusScoringEnabled);
          }
          if (bonusDescEl) {
            bonusDescEl.textContent = bonusScoringEnabled
              ? '已开启：提问者/被测者满足条件可获得额外加分'
              : '未开启：仅按投票结果计分';
          }
          if (bonusToggleEl) {
            bonusToggleEl.checked = bonusScoringEnabled;
          }

          // 同步顶部玩家数量展示，避免仅刷新卡片时顶部人数不更新。
          if (playerCountEl) {
            playerCountEl.textContent = String(data.players.length);
          }

          // 注意：API 返回的 id 是字符串，Cookie 中的 player_id 也是字符串
          const currentPlayer = data.players.find(p => p.id === currentPlayerId);
          if (currentPlayer && readyBtn) {
            const isReady = currentPlayer.is_ready;
            // 更新按钮文字和点击值
            readyBtn.textContent = isReady ? '取消准备' : '准备';
            readyBtn.setAttribute('hx-vals', `{"is_ready": "${!isReady}"}`);
          }

          // 检查是否所有玩家都已准备（房主功能）
          if (startBtn) {
            const allReady = data.players.every(p => p.is_ready);
            const playerCount = data.players.length;
            const minPlayers = data.room?.config?.min_players || 2;

            if (allReady && playerCount >= minPlayers) {
              startBtn.disabled = false;
              startBtn.textContent = '开始游戏';
              startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
              startBtn.disabled = true;
              if (playerCount < minPlayers) {
                startBtn.textContent = `需要至少 ${minPlayers} 名玩家`;
              } else {
                startBtn.textContent = '等待所有玩家准备';
              }
              startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
          }
        }
      })
      .catch(e => console.error('Failed to fetch room state:', e));
  };

  function refreshPlayerList() {
    htmx.ajax('GET', `/game/${roomId}/players`, {target: '#player-list', swap: 'outerHTML'});
  }

  // SSE 连接
  const eventSource = new EventSource(`/game/${roomId}/events`);

  eventSource.addEventListener('open', () => {
    console.log('SSE connection opened');
  });

  eventSource.addEventListener('player_joined', (e) => {
    console.log('SSE event: player_joined', e.data);
    refreshPlayerList();
    // 更新开始按钮状态（玩家数量变化可能影响开始按钮）
    window.updateReadyButtonState();
  });

  eventSource.addEventListener('player_left', (e) => {
    console.log('SSE event: player_left', e.data);
    refreshPlayerList();
    // 更新开始按钮状态（玩家数量变化可能影响开始按钮）
    window.updateReadyButtonState();
  });

  eventSource.addEventListener('player_ready_changed', (e) => {
    console.log('SSE event: player_ready_changed', e.data);
    refreshPlayerList();
    // 更新准备按钮状态
    window.updateReadyButtonState();
  });

  eventSource.addEventListener('player_kicked', (e) => {
    console.log('SSE event: player_kicked', e.data);
    const data = JSON.parse(e.data || '{}');
    const currentPlayerId = getCurrentPlayerId();
    if (data.player_id && data.player_id === currentPlayerId) {
      window.location.href = '/game';
      return;
    }
    refreshPlayerList();
    window.updateReadyButtonState();
  });

  eventSource.addEventListener('bonus_scoring_updated', (e) => {
    console.log('SSE event: bonus_scoring_updated', e.data);
    window.updateReadyButtonState();
  });

  eventSource.addEventListener('game_starting', (e) => {
    console.log('SSE event: game_starting', e.data);
    window.location.href = `/game/${roomId}/setup`;
  });

  eventSource.onerror = (e) => {
    console.log('SSE connection error', e);
  };

  window.addEventListener('beforeunload', () => {
    eventSource.close();
  });

  document.body.addEventListener('htmx:afterRequest', (evt) => {
    const path = evt.detail?.pathInfo?.requestPath || '';
    if (path.includes(`/game/${roomId}/kick/`)) {
      refreshPlayerList();
      window.updateReadyButtonState();
      return;
    }
    if (
      !path.includes(`/game/${roomId}/ready`)
      && !path.includes(`/game/${roomId}/start`)
      && !path.includes(`/game/${roomId}/bonus-scoring`)
    ) {
      return;
    }
    window.updateReadyButtonState();
  });

  // 初始化
  window.updateReadyButtonState();
});
</script>
{% endblock %}
