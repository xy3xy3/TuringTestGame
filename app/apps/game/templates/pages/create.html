{% extends "base.html" %}

{% block title %}创建房间 - 图灵测试{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 pb-16 md:p-6 md:pb-20 lg:p-8 lg:pb-24">
  <div class="mx-auto w-full max-w-2xl">
    <div class="mb-6 text-center">
      <div class="mb-4 inline-flex h-20 w-20 items-center justify-center rounded-full bg-gradient-to-r from-purple-500 to-pink-500">
        <i class="fa-solid fa-robot text-4xl text-white"></i>
      </div>
      <h1 class="mb-2 text-4xl font-bold text-white">图灵测试</h1>
      <p class="text-purple-200">创建房间</p>
    </div>

    <div class="space-y-4">
      <div class="rounded-2xl bg-white/10 p-5 backdrop-blur-md">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 class="text-2xl font-bold text-white">创建房间</h1>
            <p class="mt-1 text-sm text-purple-200">创建后会自动进入房间大厅</p>
          </div>
          <div class="flex items-center gap-2">
            <a href="/game" class="btn-secondary">房间列表</a>
            <a href="/game/join" class="btn-secondary">加入房间</a>
          </div>
        </div>
      </div>

      <div class="rounded-2xl bg-white/10 p-6 backdrop-blur-md">
        <form id="create-form" method="post" action="/game/create" hx-post="/game/create" hx-target="#create-result" hx-swap="innerHTML" hx-select="unset" hx-push-url="false">
          <div class="space-y-4">
            <div>
              <label class="mb-1 block text-sm text-purple-200">你的昵称</label>
              <input type="text" name="nickname" class="input w-full" placeholder="输入昵称" minlength="2" maxlength="32" required />
            </div>
            <div>
              <label class="mb-1 block text-sm text-purple-200">房间密码（可选）</label>
              <input type="text" name="password" class="input w-full" placeholder="留空则不设密码" />
            </div>
            <label class="flex items-start gap-2 text-sm text-purple-200">
              <input
                type="checkbox"
                name="bonus_scoring_enabled"
                value="true"
                class="mt-0.5 h-4 w-4 rounded border-white/20 bg-white/10 text-purple-500 focus:ring-purple-400"
              />
              <span>创建时开启附加给分机制（可在房间大厅继续调整）</span>
            </label>
            <button type="submit" class="btn-primary w-full">创建房间</button>
          </div>
        </form>
        <div id="create-result" class="mt-4"></div>
      </div>
    </div>
    <div class="h-6 md:h-8"></div>
  </div>
</div>

<script>
  (() => {
    const BONUS_SCORING_PREF_KEY = 'ttg_bonus_scoring_enabled';

    // 校验昵称，避免提交过短昵称造成后端报错。
    const initCreateFormValidation = () => {
      const form = document.getElementById('create-form');
      if (!form) return;
      const nicknameInput = form.querySelector('input[name="nickname"]');
      const resultDiv = document.getElementById('create-result');
      if (!nicknameInput || !resultDiv) return;

      nicknameInput.addEventListener('input', function() {
        if (this.value.length > 0 && this.value.length < 2) {
          this.setCustomValidity('昵称至少需要2个字符');
        } else {
          this.setCustomValidity('');
        }
      });

      form.addEventListener('htmx:beforeRequest', function(evt) {
        const nickname = nicknameInput.value.trim();
        if (nickname.length < 2) {
          evt.preventDefault();
          resultDiv.innerHTML = '<div class="text-sm text-red-400">昵称至少需要2个字符</div>';
        }
      });
    };

    // 记住“创建房间时是否开启附加给分机制”的用户选择。
    const initBonusScoringPreference = () => {
      const toggle = document.querySelector('#create-form input[name="bonus_scoring_enabled"]');
      if (!toggle) return;

      try {
        const saved = localStorage.getItem(BONUS_SCORING_PREF_KEY);
        if (saved === '1') {
          toggle.checked = true;
        } else if (saved === '0') {
          toggle.checked = false;
        }
      } catch (_error) {
        // 忽略浏览器禁用 localStorage 的场景。
      }

      toggle.addEventListener('change', function() {
        try {
          localStorage.setItem(BONUS_SCORING_PREF_KEY, this.checked ? '1' : '0');
        } catch (_error) {
          // 忽略写入失败，不影响正常创建房间流程。
        }
      });
    };

    initCreateFormValidation();
    initBonusScoringPreference();
  })();
</script>
{% endblock %}
