{% extends "base.html" %}

{% block title %}çµé­‚æ³¨å…¥ - å›¾çµæµ‹è¯•{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
  <div class="max-w-6xl mx-auto">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-white">çµé­‚æ³¨å…¥</h1>
        <p class="text-purple-200">è®¾ç½®ä½ çš„ AI è§’è‰²ï¼Œè®©å®ƒæˆä¸ºä½ çš„"çµé­‚"</p>
      </div>
      <div class="text-right">
        <div id="countdown" class="text-3xl font-bold text-white">{{ room.config.setup_duration }}</div>
        <p class="text-purple-200 text-sm">ç§’åå¼€å§‹</p>
        <div class="mt-2 flex items-center justify-end gap-2 text-xs">
          <span id="setup-connection-indicator" class="inline-flex items-center gap-1 rounded-full border border-white/20 bg-white/10 px-2 py-1 text-purple-100">
            <span id="setup-connection-dot" class="h-2 w-2 rounded-full bg-green-400"></span>
            <span id="setup-connection-text">å®æ—¶è¿æ¥æ­£å¸¸</span>
          </span>
          <button
            id="setup-reconnect-btn"
            type="button"
            class="rounded-full border border-white/20 bg-white/10 px-2 py-1 text-purple-100 transition hover:bg-white/20"
            onclick="forceReconnectSetupSSE('manual')"
          >
            ç«‹å³é‡è¿
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- å·¦ä¾§ï¼šç³»ç»Ÿæç¤ºè¯ -->
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ­ ç³»ç»Ÿæç¤ºè¯</h2>
        <p class="text-purple-200 text-sm mb-4">å®šä¹‰ä½ çš„ AI è§’è‰²æ€§æ ¼ã€è¯´è¯æ–¹å¼ç­‰ã€‚ä¾‹å¦‚ï¼š</p>
        <ul class="text-purple-300 text-sm mb-4 space-y-1">
          <li>â€¢ "ä½ æ˜¯ä¸€ä¸ªå‚²å¨‡çš„äºŒæ¬¡å…ƒå°‘å¥³ï¼Œå¥å°¾å¸¦'å“¼'"</li>
          <li>â€¢ "ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„ç‰©ç†å­¦å®¶ï¼Œå–œæ¬¢ç”¨ä¸“ä¸šæœ¯è¯­"</li>
          <li>â€¢ "ä½ æ˜¯ä¸€ä¸ª 7 å²å°å­©ï¼Œæ»¡æ˜¯é”™åˆ«å­—"</li>
        </ul>
        <form
          id="setup-form"
          hx-post="/game/{{ room.id }}/setup"
          hx-target="#setup-result"
          hx-swap="innerHTML"
          hx-select="unset"
          hx-push-url="false"
        >
          <div class="mb-4">
            <label class="block text-sm text-purple-200 mb-1">å¿«æ·å¥—ç”¨æ¨¡æ¿</label>
            <select id="prompt-template-select" class="input w-full">
              <option value="">è‡ªå®šä¹‰è¾“å…¥ï¼ˆä¸å¥—ç”¨ï¼‰</option>
              {% for template in prompt_templates %}
                <option value="{{ template.id }}">{{ template.name }}{% if template.description %} - {{ template.description }}{% endif %}</option>
              {% endfor %}
            </select>
            <p class="text-xs text-purple-300 mt-1">é€‰æ‹©åä¼šè‡ªåŠ¨å¡«å…¥ä¸‹æ–¹æç¤ºè¯ï¼Œä½ å¯ä»¥ç»§ç»­æ‰‹åŠ¨å¾®è°ƒã€‚</p>
          </div>

          <textarea
            name="system_prompt"
            class="input w-full h-48"
            placeholder="è¾“å…¥ä½ çš„ç³»ç»Ÿæç¤ºè¯..."
            required
          >{{ player.system_prompt or '' }}</textarea>

          <div class="mt-4">
            <label class="block text-sm text-purple-200 mb-1">é€‰æ‹© AI æ¨¡å‹</label>
            <select name="ai_model_id" class="input w-full">
              {% for model in ai_models %}
              <option value="{{ model.id|string }}" {% if player.ai_model_id == model.id|string %}selected{% endif %}>
                {{ model.name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn-primary w-full mt-4">é”å®šè®¾ç½®</button>
        </form>
        <div id="setup-result" class="mt-4"></div>
      </div>

      <!-- å³ä¾§ï¼šæµ‹è¯•å¯¹è¯ -->
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6">
        <h2 class="text-xl font-semibold text-white mb-4">ğŸ§ª å›¾çµè°ƒè¯•</h2>
        <p class="text-purple-200 text-sm mb-4">åœ¨æ­£å¼æ¸¸æˆå‰ï¼Œä¸ä½ çš„ AI æµ‹è¯•å¯¹è¯ï¼ˆæ— ä¸Šä¸‹æ–‡ï¼‰</p>

        <div id="chat-area" class="h-64 overflow-y-auto bg-white/5 rounded-xl p-4 mb-4 space-y-3">
          <div class="text-center text-purple-300 text-sm">
            å‘é€æ¶ˆæ¯æµ‹è¯•ä½ çš„ AI è§’è‰²
          </div>
        </div>

        <div class="flex gap-2">
          <input
            type="text"
            id="test-message"
            class="input flex-1"
            placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..."
            onkeypress="if(event.key==='Enter') sendTestMessage()"
          />
          <button type="button" class="btn-primary px-4" onclick="sendTestMessage()">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- å€’è®¡æ—¶è¿›åº¦æ¡ -->
    <div class="mt-6 bg-white/10 backdrop-blur-md rounded-2xl p-4">
      <div class="h-2 bg-white/20 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-1000" style="width: 100%"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
const roomId = '{{ room.id }}';
const setupTime = {{ room.config.setup_duration }};
const promptTemplates = {{ prompt_templates | tojson }};
let systemPrompt = '';
let startedAt = null;
let timerInterval = null;
let hasNavigated = false;  // é˜²æ­¢é‡å¤è·³è½¬
let setupSSEClient = null;
let phasePollingTimer = null;
let lastRemaining = setupTime;
let roomStateRequestInFlight = null;
let hasCleanedUp = false;

// setup é¡µè·³è½¬ç»Ÿä¸€èµ°è½¯å¯¼èˆªï¼Œå¤±è´¥æ—¶å›é€€ç¡¬è·³è½¬ã€‚
function navigateTo(path) {
  const nextPath = String(path || '').trim();
  if (!nextPath) return false;
  if (typeof window.ttgNavigate === 'function') {
    return window.ttgNavigate(nextPath);
  }
  window.location.href = nextPath;
  return true;
}

function bindPromptTemplateSelector() {
  const selectEl = document.getElementById('prompt-template-select');
  const textareaEl = document.querySelector('#setup-form textarea[name="system_prompt"]');
  if (!selectEl || !textareaEl) return;

  const applyTemplate = (templateId) => {
    if (!templateId) return;
    const matched = promptTemplates.find((item) => String(item.id) === String(templateId));
    if (!matched) return;
    textareaEl.value = String(matched.prompt_text || '');
    systemPrompt = textareaEl.value;
  };

  const currentValue = String(textareaEl.value || "").trim();
  if (currentValue) {
    const currentTemplate = promptTemplates.find((item) => String(item.prompt_text || "").trim() === currentValue);
    if (currentTemplate) {
      selectEl.value = String(currentTemplate.id);
    }
  }

  selectEl.addEventListener('change', () => {
    applyTemplate(selectEl.value);
  });
}

// æ›´æ–° setup é¡µè¿æ¥çŠ¶æ€ï¼Œå‘ŠçŸ¥ç©å®¶å½“å‰ç½‘ç»œä¸å®æ—¶é“¾è·¯çŠ¶æ€ã€‚
function setSetupConnectionStatus(status, customText = '') {
  const dot = document.getElementById('setup-connection-dot');
  const text = document.getElementById('setup-connection-text');
  if (!dot || !text) return;

  dot.classList.remove('bg-green-400', 'bg-yellow-400', 'bg-red-400');
  if (status === 'connected') {
    dot.classList.add('bg-green-400');
    text.textContent = customText || 'å®æ—¶è¿æ¥æ­£å¸¸';
    return;
  }
  if (status === 'offline') {
    dot.classList.add('bg-red-400');
    text.textContent = customText || 'ç½‘ç»œæ–­å¼€ï¼Œç­‰å¾…æ¢å¤';
    return;
  }
  dot.classList.add('bg-yellow-400');
  text.textContent = customText || 'è¿æ¥æ³¢åŠ¨ï¼Œé‡è¿ä¸­...';
}

function navigateToPlay() {
  if (hasNavigated) return;
  hasNavigated = true;
  if (phasePollingTimer) {
    clearInterval(phasePollingTimer);
    phasePollingTimer = null;
  }
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  if (setupSSEClient) {
    setupSSEClient.close();
    setupSSEClient = null;
  }
  navigateTo(`/game/${roomId}/play`);
}

function redirectByRoomPhase(phase) {
  const normalized = String(phase || '').trim().toLowerCase();
  if (normalized === 'playing') {
    navigateToPlay();
    return true;
  }
  if (normalized === 'waiting') {
    hasNavigated = true;
    navigateTo(`/game/${roomId}`);
    return true;
  }
  if (normalized === 'finished') {
    hasNavigated = true;
    navigateTo(`/game/${roomId}/result`);
    return true;
  }
  return false;
}

function ensurePhasePolling() {
  if (hasNavigated || phasePollingTimer) return;
  syncRoomState({ silent: true });
  phasePollingTimer = setInterval(() => {
    syncRoomState({ silent: true });
  }, 1000);
}

// è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆåŸºäºæœåŠ¡å™¨ UTC æ—¶é—´æˆ³ï¼‰
function getRemainingTime() {
  if (!startedAt) return setupTime;
  const now = Date.now();
  const elapsed = (now - startedAt) / 1000;  // è½¬æ¢ä¸ºç§’
  // ä½¿ç”¨ ceil é¿å…æœ¬åœ°è®¡æ—¶â€œæŠ¢è·‘â€å¯¼è‡´æ¯”æœåŠ¡ç«¯å…ˆå‡ 1ã€‚
  const remaining = Math.max(0, Math.ceil(setupTime - elapsed));
  return remaining;
}

function applyCountdown(remainingValue) {
  const parsed = Number(remainingValue);
  if (!Number.isFinite(parsed)) return;

  const normalized = Math.max(0, Math.min(setupTime, Math.floor(parsed)));
  // SSE ä¸æœ¬åœ°å®šæ—¶å™¨å¹¶å­˜æ—¶ï¼Œç½‘ç»œæŠ–åŠ¨å¯èƒ½è®©æ—§äº‹ä»¶æ™šåˆ°ï¼Œå¯¼è‡´æ•°å­—â€œå€’ç€èµ°â€ã€‚
  // è¿™é‡Œå¼ºåˆ¶å€’è®¡æ—¶å•è°ƒä¸å¢ï¼Œé¿å…å³ä¸Šè§’å‡ºç°å›å¼¹ã€‚
  const remaining = Math.min(normalized, lastRemaining);
  lastRemaining = remaining;

  document.getElementById('countdown').textContent = remaining;
  document.getElementById('progress-bar').style.width = `${(remaining / setupTime) * 100}%`;

  // å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨è·³è½¬
  if (remaining <= 0 && !hasNavigated) {
    // æ³¨æ„ï¼šè¿™é‡Œä¸ç«‹åˆ»è·³è½¬ï¼Œç­‰å¾…æœåŠ¡ç«¯æˆ¿é—´çŠ¶æ€çœŸæ­£è¿›å…¥ playingã€‚
    // å¦åˆ™å¯èƒ½è¢« /play -> /setup é‡å®šå‘å›å¼¹ï¼Œå‡ºç° 0 å’Œåˆå§‹å€¼æ¥å›è·³åŠ¨ã€‚
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    ensurePhasePolling();
  }
}

// æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
function updateCountdown() {
  applyCountdown(getRemainingTime());
}

async function syncRoomState(options = {}) {
  if (hasNavigated) return;
  const silent = Boolean(options.silent);
  if (roomStateRequestInFlight) {
    return roomStateRequestInFlight;
  }

  roomStateRequestInFlight = (async () => {
    try {
      const requestFn = typeof window.requestWithRetry === 'function' ? window.requestWithRetry : fetch;
      const response = await requestFn(`/game/api/${roomId}/state`, { cache: 'no-store' }, { timeoutMs: 5000, retries: 1 });
      const data = await response.json();
      if (!data.success || !data.room) {
        return;
      }

      if (redirectByRoomPhase(data.room.phase)) return;

      if (data.room.phase === 'setup' && data.room.started_at) {
        startedAt = new Date(data.room.started_at).getTime();
        updateCountdown();
      }
    } catch (error) {
      if (!silent) {
        console.error('Failed to fetch room state:', error);
      }
    } finally {
      roomStateRequestInFlight = null;
    }
  })();

  return roomStateRequestInFlight;
}

// åˆå§‹åŒ–å€’è®¡æ—¶æ˜¾ç¤º
updateCountdown();
bindPromptTemplateSelector();
setSetupConnectionStatus(navigator.onLine ? 'reconnecting' : 'offline', navigator.onLine ? 'åˆå§‹åŒ–è¿æ¥ä¸­...' : 'ç½‘ç»œæ–­å¼€ï¼Œç­‰å¾…æ¢å¤');
syncRoomState();
ensurePhasePolling();

// å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°
timerInterval = setInterval(updateCountdown, 1000);

// SSE ç›‘å¬ï¼ˆå«æ–­çº¿è‡ªåŠ¨é‡è¿ä¸åœ¨çº¿çŠ¶æ€å›è°ƒï¼‰ã€‚
setupSSEClient = window.createResilientSSE({
  url: `/game/${roomId}/events`,
  onStatusChange: (status) => {
    if (status === 'connected') {
      setSetupConnectionStatus('connected');
      return;
    }
    if (status === 'offline') {
      setSetupConnectionStatus('offline');
      return;
    }
    setSetupConnectionStatus('reconnecting');
  },
  events: {
    ping: () => {},
    game_starting: (e) => {
      const data = JSON.parse(e.data || '{}');
      if (data.started_at) {
        startedAt = new Date(data.started_at).getTime();
        updateCountdown();
      }
    },
    countdown: (e) => {
      const data = JSON.parse(e.data || '{}');
      const eventPhase = String(data.phase || '').trim().toLowerCase();
      if (eventPhase && eventPhase !== 'setup') {
        navigateToPlay();
        return;
      }

      if (data.remaining !== undefined) {
        if (data.started_at) {
          startedAt = new Date(data.started_at).getTime();
        }
        applyCountdown(data.remaining);
      } else if (data.started_at) {
        startedAt = new Date(data.started_at).getTime();
        updateCountdown();
      }
    },
    game_start: () => {
      navigateToPlay();
    },
    game_error: (e) => {
      const data = JSON.parse(e.data || '{}');
      alert(data.error || 'æ¸¸æˆçŠ¶æ€å¼‚å¸¸');
      navigateTo(`/game/${roomId}`);
    },
  },
});
setupSSEClient.connect('setup_initial');

function forceReconnectSetupSSE(reason = 'manual') {
  if (!setupSSEClient) return;
  setupSSEClient.forceReconnect(reason);
}

// æµ‹è¯•æ¶ˆæ¯å‘é€
async function sendTestMessage() {
  const input = document.getElementById('test-message');
  const message = input.value.trim();
  if (!message) return;

  // è·å–å½“å‰ç³»ç»Ÿæç¤ºè¯å’Œé€‰æ‹©çš„ AI æ¨¡å‹
  const form = document.getElementById('setup-form');
  systemPrompt = form.querySelector('textarea[name="system_prompt"]').value;
  const aiModelId = form.querySelector('select[name="ai_model_id"]').value;

  if (!systemPrompt) {
    alert('è¯·å…ˆå¡«å†™ç³»ç»Ÿæç¤ºè¯');
    return;
  }

  // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  const chatArea = document.getElementById('chat-area');
  chatArea.innerHTML += `<div class="text-right"><div class="inline-block bg-purple-500/30 rounded-lg px-3 py-2 text-white">${message}</div></div>`;

  input.value = '';
  chatArea.scrollTop = chatArea.scrollHeight;

  // è°ƒç”¨ AI
  chatArea.innerHTML += `<div class="text-center text-purple-300 text-sm">AI æ­£åœ¨æ€è€ƒ...</div>`;
  chatArea.scrollTop = chatArea.scrollHeight;

  const requestBody = {
    system_prompt: systemPrompt,
    message: message,
  };

  // å¦‚æœé€‰æ‹©äº† AI æ¨¡å‹ï¼Œä¹Ÿä¼ é€’æ¨¡å‹ ID
  if (aiModelId) {
    requestBody.model_id = aiModelId;
  }

  try {
    const requestFn = typeof window.requestWithRetry === 'function' ? window.requestWithRetry : fetch;
    const response = await requestFn(
      '/game/api/chat',
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestBody),
      },
      {
        timeoutMs: 7000,
        retries: 2,
      },
    );
    const result = await response.json();

    if (result.success) {
      chatArea.innerHTML += `<div class="text-left"><div class="inline-block bg-pink-500/30 rounded-lg px-3 py-2 text-white">${result.content}</div></div>`;
    } else {
      chatArea.innerHTML += `<div class="text-left"><div class="inline-block bg-red-500/30 rounded-lg px-3 py-2 text-red-300">${result.error || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}</div></div>`;
    }
  } catch (_error) {
    chatArea.innerHTML += `<div class="text-left"><div class="inline-block bg-red-500/30 rounded-lg px-3 py-2 text-red-300">ç½‘ç»œå¼‚å¸¸ï¼Œæœªèƒ½å®Œæˆè°ƒè¯•è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•ã€‚</div></div>`;
  } finally {
    // ç§»é™¤æ€è€ƒä¸­æç¤º
    chatArea.querySelectorAll('.text-center.text-purple-300').forEach((el) => el.remove());
    chatArea.scrollTop = chatArea.scrollHeight;
  }
}

// é¡µé¢é€€å‡ºæ—¶æ¸…ç† SSE ä¸è½®è¯¢ï¼Œé¿å…è½¯å¯¼èˆªåæ®‹ç•™æ—§è¿æ¥ã€‚
function cleanupSetupPage() {
  if (hasCleanedUp) return;
  hasCleanedUp = true;
  if (phasePollingTimer) {
    clearInterval(phasePollingTimer);
    phasePollingTimer = null;
  }
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  if (setupSSEClient) {
    setupSSEClient.close();
    setupSSEClient = null;
  }
  if (window.forceReconnectSetupSSE === forceReconnectSetupSSE) {
    delete window.forceReconnectSetupSSE;
  }
  if (window.sendTestMessage === sendTestMessage) {
    delete window.sendTestMessage;
  }
}

window.forceReconnectSetupSSE = forceReconnectSetupSSE;
window.sendTestMessage = sendTestMessage;

if (typeof window.registerGamePageCleanup === 'function') {
  window.registerGamePageCleanup(cleanupSetupPage);
} else {
  window.addEventListener('beforeunload', cleanupSetupPage, { once: true });
}
})();
</script>
{% endblock %}
