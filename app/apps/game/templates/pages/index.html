{% extends "base.html" %}

{% block title %}图灵测试游戏{% endblock %}

{% block content %}
<div
  class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
  <div class="max-w-md w-full">
    <!-- Logo 和标题 -->
    <div class="text-center mb-8">
      <div
        class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 mb-4">
        <i class="fa-solid fa-robot text-4xl text-white"></i>
      </div>
      <h1 class="text-4xl font-bold text-white mb-2">图灵测试</h1>
      <p class="text-purple-200">你是人还是 AI？一起来挑战吧！</p>
    </div>

    <!-- 创建房间 -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6">
      <h2 class="text-xl font-semibold text-white mb-4">创建房间</h2>
      <form id="create-form" hx-post="/game/create" hx-target="#create-result" hx-swap="innerHTML">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-purple-200 mb-1">你的昵称</label>
            <input type="text" name="nickname" class="input w-full" placeholder="输入昵称" minlength="2" maxlength="32" required />
          </div>
          <div>
            <label class="block text-sm text-purple-200 mb-1">房间密码（可选）</label>
            <input type="text" name="password" class="input w-full" placeholder="留空则不设密码" />
          </div>
          <button type="submit" class="btn-primary w-full">创建房间</button>
        </div>
      </form>
      <div id="create-result" class="mt-4"></div>
    </div>

    <!-- 加入房间 -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6">
      <h2 class="text-xl font-semibold text-white mb-4">加入房间</h2>
      <form id="join-form" hx-post="/game/join" hx-target="#join-result" hx-swap="innerHTML">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-purple-200 mb-1">房间号</label>
            <input type="text" name="room_code" class="input w-full" placeholder="输入房间号" required />
          </div>
          <div>
            <label class="block text-sm text-purple-200 mb-1">你的昵称</label>
            <input type="text" name="nickname" class="input w-full" placeholder="输入昵称" minlength="2" maxlength="32" required />
          </div>
          <div>
            <label class="block text-sm text-purple-200 mb-1">房间密码（可选）</label>
            <input type="text" name="password" class="input w-full" placeholder="如果房间有密码" />
          </div>
          <button type="submit"
            class="btn-primary w-full bg-gradient-to-r from-pink-500 to-purple-500 border-0">加入房间</button>
        </div>
      </form>
      <div id="join-result" class="mt-4"></div>
    </div>

    <!-- 游戏说明 -->
    <div class="mt-8 text-center text-purple-300 text-sm">
      <p>游戏规则：</p>
      <ul class="mt-2 space-y-1 text-left max-w-xs mx-auto">
        <li>• 每位玩家设置自己的 AI 角色</li>
        <li>• 轮流提问和回答</li>
        <li>• 判断回答者是人还是 AI</li>
        <li>• 欺骗他人得分，识破 AI 也得分</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // 表单验证
  function validateNickname(formId) {
    const form = document.getElementById(formId);
    const nicknameInput = form.querySelector('input[name="nickname"]');
    const resultDiv = document.getElementById(formId.replace('-form', '-result'));

    nicknameInput.addEventListener('input', function() {
      if (this.value.length > 0 && this.value.length < 2) {
        this.setCustomValidity('昵称至少需要2个字符');
      } else {
        this.setCustomValidity('');
      }
    });

    form.addEventListener('htmx:beforeRequest', function(evt) {
      const nickname = nicknameInput.value.trim();
      if (nickname.length < 2) {
        evt.preventDefault();
        resultDiv.innerHTML = '<div class="text-red-400 text-sm">昵称至少需要2个字符</div>';
      }
    });
  }

  validateNickname('create-form');
  validateNickname('join-form');

  document.addEventListener('htmx:afterSwap', function (evt) {
    const target = evt.detail.target;
    if (target.id === 'create-result' || target.id === 'join-result') {
      try {
        const data = JSON.parse(target.textContent);
        if (data.success) {
          // 设置 Cookie
          document.cookie = `player_id=${data.player_id}; path=/; max-age=86400`;
          document.cookie = `player_token=${data.token}; path=/; max-age=86400`;
          // 跳转
          window.location.href = `/game/${data.room_id}`;
        }
      } catch (e) { }
    }
  });
</script>
{% endblock %}