{% extends "base.html" %}

{% block title %}房间列表 - 图灵测试{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 md:p-6 lg:p-8">
  <div class="mx-auto w-full" style="max-width: 1120px;">
    <div class="mb-6 text-center">
      <div class="mb-4 inline-flex h-20 w-20 items-center justify-center rounded-full bg-gradient-to-r from-purple-500 to-pink-500">
        <i class="fa-solid fa-robot text-4xl text-white"></i>
      </div>
      <h1 class="mb-2 text-4xl font-bold text-white">图灵测试</h1>
      <p class="text-purple-200">房间列表首页</p>
    </div>

    <div id="resume-game-card" class="mb-6 hidden rounded-2xl border border-green-300/20 bg-green-500/10 p-4 backdrop-blur-md">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-sm font-semibold text-green-200">检测到你有未结束的对局</p>
          <p id="resume-game-detail" class="mt-1 text-xs text-green-100/90">可继续返回上一局。</p>
        </div>
        <button
          id="resume-game-btn"
          type="button"
          class="btn-primary whitespace-nowrap px-4 py-2 text-sm"
        >
          继续上局
        </button>
      </div>
    </div>

    <div class="mb-4 rounded-2xl bg-white/10 p-5 backdrop-blur-md">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-2xl font-bold text-white">房间列表</h2>
          <p class="mt-1 text-sm text-purple-200">展示所有等待中的房间（含加锁房间）</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <a href="/game/create" class="btn-primary">
            <i class="fa-solid fa-plus mr-1"></i>创建房间
          </a>
          <a href="/game/join" class="btn-secondary">
            <i class="fa-solid fa-right-to-bracket mr-1"></i>加入房间
          </a>
          <button
            class="btn-secondary"
            hx-get="/game/rooms/table"
            hx-target="#room-cards-wrap"
            hx-swap="outerHTML"
            hx-select="unset"
            hx-push-url="false"
            hx-indicator="#global-indicator"
          >
            <i class="fa-solid fa-rotate-right mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <section>
      {% include "partials/room_cards.html" %}
    </section>

    <div class="mx-auto mt-8 max-w-2xl text-center text-sm text-purple-300">
      <p>快速开始：</p>
      <ul class="mx-auto mt-2 max-w-xs space-y-1 text-left">
        <li>• 房主先创建房间并分享邀请码</li>
        <li>• 玩家从列表或邀请码进入加入页</li>
        <li>• 全员准备后开始图灵测试对局</li>
      </ul>
    </div>
  </div>
</div>

<script>
  (() => {
    // 检测是否存在可恢复的对局，给出“继续上局”入口但不强制跳转。
    const initResumeGameCard = async () => {
      const cardEl = document.getElementById('resume-game-card');
      const detailEl = document.getElementById('resume-game-detail');
      const btnEl = document.getElementById('resume-game-btn');
      if (!cardEl || !btnEl || !detailEl) return;

      try {
        const requestFn = typeof window.requestWithRetry === 'function' ? window.requestWithRetry : fetch;
        const response = await requestFn(
          '/game/reconnect',
          { method: 'POST' },
          { timeoutMs: 4500, retries: 1 },
        );
        const data = await response.json();
        if (!data.success || !data.redirect) return;

        detailEl.textContent = `房间号：${data.room_code || '-'} · 当前阶段：${data.phase || 'unknown'}`;
        btnEl.addEventListener('click', () => {
          window.location.href = data.redirect;
        });
        cardEl.classList.remove('hidden');
      } catch (_error) {
        // 静默失败：不影响首页主流程。
      }
    };

    initResumeGameCard();
  })();
</script>
{% endblock %}
