<div id="role-table" class="card p-5" {% if request.state.permission_flags.rbac['delete'] %}data-bulk-scope{% endif %}>
  {% set rbac_perm = request.state.permission_flags.rbac %}
  {% set show_action_col = rbac_perm['update'] or rbac_perm['delete'] %}
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold text-slate-900">角色列表</h2>
      <p class="mt-1 text-sm text-slate-500">共 {{ pagination.total }} 条记录</p>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button
        class="btn-ghost px-3"
        hx-get="/admin/rbac/roles/table"
        hx-target="#role-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
        title="刷新"
        aria-label="刷新"
      >
        <i class="fa-solid fa-rotate-right" aria-hidden="true"></i>
      </button>
      {% if rbac_perm['read'] %}
        <a class="btn-ghost" href="/admin/rbac/roles/export?include_system=1">导出 JSON</a>
      {% endif %}
      {% if rbac_perm['update'] %}
        <button
          class="btn-ghost"
          hx-get="/admin/rbac/roles/import"
          hx-target="#modal-body"
          hx-swap="innerHTML"
          hx-indicator="#global-indicator"
          hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
          x-on:click="modalOpen = true"
        >
          导入 JSON
        </button>
      {% endif %}
      {% if rbac_perm['create'] %}
        <button
          class="btn-primary"
          hx-get="/admin/rbac/roles/new"
          hx-target="#modal-body"
          hx-swap="innerHTML"
          hx-indicator="#global-indicator"
          hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
          x-on:click="modalOpen = true"
        >
          新建角色
        </button>
      {% endif %}
    </div>
  </div>

  {% if rbac_perm['delete'] %}
    <form
      class="mt-4 space-y-4 pb-20"
    >
      <input type="hidden" name="csrf_token" value="{{ request.state.csrf_token or '' }}" />
      <input type="hidden" name="search_q" value="{{ filters.search_q }}" />
      <input type="hidden" name="search_status" value="{{ filters.search_status }}" />
      <input type="hidden" name="search_sort" value="{{ filters.search_sort }}" />
      <input type="hidden" name="page" value="{{ pagination.page }}" />

      <div class="flex flex-wrap items-center justify-between gap-3 rounded-lg border border-slate-200 bg-slate-50/60 p-3">
        <p class="text-xs text-slate-500">已选 <span data-bulk-count>0</span> 项</p>
        <button type="button" class="btn-ghost px-3" data-bulk-action="invert">反选</button>
      </div>

      {% if roles %}
        <div class="overflow-x-auto rounded-lg border border-slate-200">
          <table class="w-full min-w-[920px] text-left text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="w-12 px-4 py-3 text-center font-medium">
                  <input type="checkbox" class="h-4 w-4" data-bulk-master aria-label="全选本页" />
                </th>
                <th class="px-4 py-3 font-medium">标识</th>
                <th class="px-4 py-3 font-medium">名称</th>
                <th class="px-4 py-3 font-medium">描述</th>
                <th class="px-4 py-3 font-medium">状态</th>
                <th class="px-4 py-3 font-medium">更新时间</th>
                {% if show_action_col %}<th class="px-4 py-3 text-right font-medium">操作</th>{% endif %}
              </tr>
            </thead>
            <tbody>
              {% for role in roles %}
                {% set meta = status_meta[role.status] %}
                {% set is_system_role = role.slug in ["super", "admin", "viewer"] %}
                <tr class="border-t border-slate-100">
                  <td class="px-4 py-3 text-center">
                    <input
                      type="checkbox"
                      class="h-4 w-4"
                      name="selected_slugs"
                      value="{{ role.slug }}"
                      data-bulk-item
                      {% if is_system_role %}disabled title="系统角色不允许删除"{% endif %}
                    />
                  </td>
                  <td class="px-4 py-3 font-medium text-slate-900">{{ role.slug }}</td>
                  <td class="px-4 py-3">{{ role.name }}</td>
                  <td class="px-4 py-3 text-slate-500">{{ role.description or "-" }}</td>
                  <td class="px-4 py-3">
                    <span class="tag" style="border-color: {{ meta.color }}; color: {{ meta.color }};">
                      {{ meta.label }}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-slate-500">{{ role.updated_at | fmt_dt }}</td>
                  {% if show_action_col %}
                    <td class="px-4 py-3 text-right">
                      {% if rbac_perm['update'] %}
                        <button
                          type="button"
                          class="btn-link"
                          hx-get="/admin/rbac/roles/{{ role.slug }}/edit"
                          hx-target="#modal-body"
                          hx-swap="innerHTML"
                          hx-indicator="#global-indicator"
                          hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
                          x-on:click="modalOpen = true"
                        >
                          编辑
                        </button>
                      {% endif %}
                      {% if rbac_perm['delete'] %}
                        <button
                          type="button"
                          class="btn-link {% if rbac_perm['update'] %}ml-3 {% endif %}text-red-500 hover:text-red-600"
                          hx-delete="/admin/rbac/roles/{{ role.slug }}"
                          hx-target="#role-table"
                          hx-swap="outerHTML"
                          hx-confirm="确认删除该角色吗？"
                          hx-indicator="#global-indicator"
                          hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
                        >
                          删除
                        </button>
                      {% endif %}
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="rounded-lg border border-dashed border-slate-200 bg-slate-50/70 p-10 text-center">
          <p class="text-lg font-semibold text-slate-800">暂无角色数据</p>
          <p class="mt-2 text-sm text-slate-500">点击右上角“新建角色”开始配置权限。</p>
        </div>
      {% endif %}

      <div
        class="bulk-fixed-layer fixed bottom-0 z-20 hidden h-16 bg-slate-900/10 backdrop-blur-[2px]"
        data-bulk-overlay
        aria-hidden="true"
      ></div>
      <div
        class="bulk-fixed-layer fixed bottom-0 z-30 hidden border-t border-slate-200/80 bg-white/65 shadow-[0_-8px_20px_rgba(15,23,42,0.12)] backdrop-blur-md"
        data-bulk-bottom
      >
        <div class="mx-auto flex w-full max-w-[1440px] items-center justify-between gap-3 px-4 py-3">
          <p class="text-sm text-slate-700">已选择 <strong data-bulk-count>0</strong> 项</p>
          <button
            type="button"
            class="btn-ghost text-red-500 hover:text-red-600"
            data-bulk-submit
            hx-post="/admin/rbac/roles/bulk-delete"
            hx-include="closest form"
            hx-target="#role-table"
            hx-swap="outerHTML"
            hx-indicator="#global-indicator"
            hx-confirm="确认批量删除已勾选的角色吗？"
            disabled
          >
            批量删除
          </button>
        </div>
      </div>
    </form>
  {% else %}
    {% if roles %}
      <div class="mt-4 overflow-x-auto rounded-lg border border-slate-200">
        <table class="w-full min-w-[860px] text-left text-sm">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-3 font-medium">标识</th>
              <th class="px-4 py-3 font-medium">名称</th>
              <th class="px-4 py-3 font-medium">描述</th>
              <th class="px-4 py-3 font-medium">状态</th>
              <th class="px-4 py-3 font-medium">更新时间</th>
              {% if show_action_col %}<th class="px-4 py-3 text-right font-medium">操作</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for role in roles %}
              {% set meta = status_meta[role.status] %}
              <tr class="border-t border-slate-100">
                <td class="px-4 py-3 font-medium text-slate-900">{{ role.slug }}</td>
                <td class="px-4 py-3">{{ role.name }}</td>
                <td class="px-4 py-3 text-slate-500">{{ role.description or "-" }}</td>
                <td class="px-4 py-3">
                  <span class="tag" style="border-color: {{ meta.color }}; color: {{ meta.color }};">
                    {{ meta.label }}
                  </span>
                </td>
                <td class="px-4 py-3 text-slate-500">{{ role.updated_at | fmt_dt }}</td>
                {% if show_action_col %}
                  <td class="px-4 py-3 text-right">
                    {% if rbac_perm['update'] %}
                      <button
                        class="btn-link"
                        hx-get="/admin/rbac/roles/{{ role.slug }}/edit"
                        hx-target="#modal-body"
                        hx-swap="innerHTML"
                        hx-indicator="#global-indicator"
                        hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
                        x-on:click="modalOpen = true"
                      >
                        编辑
                      </button>
                    {% endif %}
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="mt-4 rounded-lg border border-dashed border-slate-200 bg-slate-50/70 p-10 text-center">
        <p class="text-lg font-semibold text-slate-800">暂无角色数据</p>
        <p class="mt-2 text-sm text-slate-500">点击右上角“新建角色”开始配置权限。</p>
      </div>
    {% endif %}
  {% endif %}

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 border-t border-slate-100 pt-4">
    <p class="text-xs text-slate-500">显示 {{ pagination.start_item }} - {{ pagination.end_item }} / {{ pagination.total }}</p>

    <div class="flex flex-wrap items-center gap-2">
      <button
        class="btn-ghost px-3 {% if not pagination.has_prev %}opacity-50 pointer-events-none{% endif %}"
        hx-get="/admin/rbac/roles/table"
        hx-target="#role-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.prev_page}|tojson }}'
        {% if not pagination.has_prev %}disabled{% endif %}
      >
        上一页
      </button>
      {% for p in pagination.pages %}
        <button
          class="{% if p == pagination.page %}btn-primary{% else %}btn-ghost{% endif %} px-3"
          hx-get="/admin/rbac/roles/table"
          hx-target="#role-table"
          hx-swap="outerHTML"
          hx-indicator="#global-indicator"
          hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": p}|tojson }}'
        >
          {{ p }}
        </button>
      {% endfor %}
      <button
        class="btn-ghost px-3 {% if not pagination.has_next %}opacity-50 pointer-events-none{% endif %}"
        hx-get="/admin/rbac/roles/table"
        hx-target="#role-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.next_page}|tojson }}'
        {% if not pagination.has_next %}disabled{% endif %}
      >
        下一页
      </button>
    </div>
  </div>
</div>
