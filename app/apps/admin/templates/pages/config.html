{% extends "base.html" %}

{% block content %}
<div class="space-y-4" x-data='{ "configTab": {{ active_config_tab | tojson }} }'>
  {% set config_perm = request.state.permission_flags.config %}
  <form class="space-y-4" method="post" action="/admin/config">
    <input type="hidden" name="csrf_token" value="{{ request.state.csrf_token or '' }}" />
    <input type="hidden" name="config_tab" x-model="configTab" />

    <section class="card p-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 class="text-lg font-semibold text-slate-900">系统配置</h1>
          <p class="text-sm text-slate-500">按页签切换：系统设置 / 备份设置 / 数据清理 / 游戏时间</p>
        </div>

        <div class="inline-flex rounded-md border border-slate-200 bg-white p-1">
          <button
            type="button"
            class="rounded-md border px-3 py-1.5 text-sm font-medium transition-colors"
            :class="configTab === 'system' ? 'border-blue-200 bg-blue-50 text-blue-700' : 'border-transparent text-slate-600 hover:border-slate-200 hover:bg-slate-50'"
            x-on:click="configTab = 'system'"
          >
            系统设置
          </button>
          <button
            type="button"
            class="rounded-md border px-3 py-1.5 text-sm font-medium transition-colors"
            :class="configTab === 'backup' ? 'border-blue-200 bg-blue-50 text-blue-700' : 'border-transparent text-slate-600 hover:border-slate-200 hover:bg-slate-50'"
            x-on:click="configTab = 'backup'"
          >
            备份设置
          </button>
          <button
            type="button"
            class="rounded-md border px-3 py-1.5 text-sm font-medium transition-colors"
            :class="configTab === 'cleanup' ? 'border-blue-200 bg-blue-50 text-blue-700' : 'border-transparent text-slate-600 hover:border-slate-200 hover:bg-slate-50'"
            x-on:click="configTab = 'cleanup'"
          >
            数据清理
          </button>
          <button
            type="button"
            class="rounded-md border px-3 py-1.5 text-sm font-medium transition-colors"
            :class="configTab === 'game_time' ? 'border-blue-200 bg-blue-50 text-blue-700' : 'border-transparent text-slate-600 hover:border-slate-200 hover:bg-slate-50'"
            x-on:click="configTab = 'game_time'"
          >
            游戏时间
          </button>
        </div>
      </div>

      {% if saved %}
        <div class="mt-4 rounded-md border border-blue-100 bg-blue-50 px-3 py-2 text-sm text-blue-600">
          配置已保存。
        </div>
      {% endif %}

      {% if not config_perm['update'] %}
        <div class="mt-4 rounded-md border border-amber-100 bg-amber-50 px-3 py-2 text-sm text-amber-700">
          当前角色仅有查看权限，不能修改系统配置。
        </div>
      {% endif %}
    </section>

    <section class="card p-5" x-show="configTab === 'system'" x-cloak>
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-base font-semibold text-slate-900">站点设置</h2>
        <p class="text-sm text-slate-500">配置 SMTP 参数与站点日志策略</p>
      </div>

      <div class="mt-4 grid gap-4 md:grid-cols-12">
        <div class="md:col-span-12">
          <label class="label">系统访问地址（Base URL）</label>
          <input name="base_url" class="input" value="{{ base_url }}" placeholder="http://127.0.0.1:8000" {% if not config_perm['update'] %}readonly{% endif %} />
          <p class="text-xs text-slate-500 mt-1">用于生成邀请链接等外部访问地址，如：http://your-domain.com:8000</p>
        </div>
        <div class="md:col-span-12">
          <label class="label">底部版权文案</label>
          <input
            name="footer_copyright_text"
            class="input"
            value="{{ footer_copyright.text }}"
            placeholder="TuringTestGame"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">用于页面底部展示文案，例如：Powered by TuringTestGame。</p>
        </div>
        <div class="md:col-span-12">
          <label class="label">底部版权链接</label>
          <input
            name="footer_copyright_url"
            class="input"
            value="{{ footer_copyright.url }}"
            placeholder="https://github.com/xy3xy3/TuringTestGame"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">底部版权点击后跳转地址，默认推广仓库链接。</p>
        </div>

        <div class="md:col-span-12">
          <div class="rounded-md border border-slate-200 bg-slate-50 p-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h3 class="text-sm font-semibold text-slate-900">IP 限流（防 CC）</h3>
                <p class="mt-1 text-xs text-slate-500">
                  支持按 IP 对游戏写接口限流；若部署在 Nginx 反向代理后，可启用“信任代理 IP 头”读取
                  <code>X-Forwarded-For</code> / <code>X-Real-IP</code>。
                </p>
              </div>
            </div>

            <div class="mt-4 grid gap-4 md:grid-cols-12">
              <div class="md:col-span-6">
                <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    name="rate_limit_enabled"
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                    {% if rate_limit_config.enabled %}checked{% endif %}
                    {% if not config_perm['update'] %}disabled{% endif %}
                  />
                  <span>启用 IP 限流</span>
                </label>
              </div>
              <div class="md:col-span-6">
                <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    name="rate_limit_trust_proxy_headers"
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                    {% if rate_limit_config.trust_proxy_headers %}checked{% endif %}
                    {% if not config_perm['update'] %}disabled{% endif %}
                  />
                  <span>信任代理 IP 头（Nginx）</span>
                </label>
              </div>

              <div class="md:col-span-4">
                <label class="label">限流窗口（秒）</label>
                <input
                  type="number"
                  min="1"
                  name="rate_limit_window_seconds"
                  class="input"
                  value="{{ rate_limit_config.window_seconds }}"
                  {% if not config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-4">
                <label class="label">通用写接口上限</label>
                <input
                  type="number"
                  min="1"
                  name="rate_limit_max_requests"
                  class="input"
                  value="{{ rate_limit_config.max_requests }}"
                  {% if not config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-4">
                <label class="label">测试对话接口上限</label>
                <input
                  type="number"
                  min="1"
                  name="rate_limit_chat_api_max_requests"
                  class="input"
                  value="{{ rate_limit_config.chat_api_max_requests }}"
                  {% if not config_perm['update'] %}readonly{% endif %}
                />
              </div>

              <div class="md:col-span-6">
                <label class="label">创建房间上限</label>
                <input
                  type="number"
                  min="1"
                  name="rate_limit_create_room_max_requests"
                  class="input"
                  value="{{ rate_limit_config.create_room_max_requests }}"
                  {% if not config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">加入房间上限</label>
                <input
                  type="number"
                  min="1"
                  name="rate_limit_join_room_max_requests"
                  class="input"
                  value="{{ rate_limit_config.join_room_max_requests }}"
                  {% if not config_perm['update'] %}readonly{% endif %}
                />
              </div>
            </div>
          </div>
        </div>
        <div class="md:col-span-8">
          <label class="label">SMTP 主机</label>
          <input name="smtp_host" class="input" value="{{ smtp.smtp_host }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
        <div class="md:col-span-4">
          <label class="label">SMTP 端口</label>
          <input name="smtp_port" class="input" value="{{ smtp.smtp_port }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
        <div class="md:col-span-12">
          <label class="label">SMTP 用户名</label>
          <input name="smtp_user" class="input" value="{{ smtp.smtp_user }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
        <div class="md:col-span-12">
          <label class="label">SMTP 密码</label>
          <input name="smtp_pass" type="password" class="input" value="{{ smtp.smtp_pass }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
        <div class="md:col-span-8">
          <label class="label">发件人地址</label>
          <input name="smtp_from" class="input" value="{{ smtp.smtp_from }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
        <div class="md:col-span-4">
          <label class="label">启用 SSL (true/false)</label>
          <input name="smtp_ssl" class="input" value="{{ smtp.smtp_ssl }}" {% if not config_perm['update'] %}readonly{% endif %} />
        </div>
      </div>

      <div class="mt-6 border-t border-slate-100 pt-4">
        <h3 class="text-base font-semibold text-slate-900">操作日志记录类型</h3>
        <p class="mt-1 text-sm text-slate-500">选择写入“操作日志”页面的增删改查类型。</p>

        <div class="mt-4 grid gap-3 md:grid-cols-4">
          {% for key, label in audit_action_labels.items() %}
            <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
              <input
                type="checkbox"
                name="audit_actions"
                value="{{ key }}"
                class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                {% if key in audit_actions %}checked{% endif %}
                {% if not config_perm['update'] %}disabled{% endif %}
              />
              <span>{{ label }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    </section>

    <section
      id="backup-settings"
      class="card p-5"
      x-show="configTab === 'backup'"
      x-cloak
      x-data='{
        "cloudEnabled": {{ backup_config.cloud_enabled | tojson }},
        "providers": (function(v) { return Array.isArray(v) ? v : [] })({{ backup_config.cloud_providers | tojson }}),
        "hasProvider": function(provider) { return this.providers.indexOf(provider) !== -1 },
        "toggleExcludedCollections": function(mode) {
          var boxes = this.$refs.excludedWrap.querySelectorAll("input[name=\"backup_excluded_collections\"]");
          boxes.forEach(function(box) {
            if (box.disabled) { return }
            if (mode === "all") { box.checked = true }
            else if (mode === "none") { box.checked = false }
            else { box.checked = !box.checked }
          });
        }
      }'
    >
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 class="text-base font-semibold text-slate-900">备份配置（OSS / COS）</h2>
        {% if request.state.permission_flags.backup_records['read'] %}
          <a href="/admin/backup" class="text-sm text-blue-600 hover:text-blue-700">前往备份管理</a>
        {% endif %}
      </div>

      <div class="mt-4 grid gap-4 md:grid-cols-12">
        <div class="md:col-span-4">
          <label class="label">自动备份</label>
          <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
            <input
              type="checkbox"
              name="backup_enabled"
              class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
              {% if backup_config.enabled %}checked{% endif %}
              {% if not config_perm['update'] %}disabled{% endif %}
            />
            <span>启用定时备份</span>
          </label>
        </div>
        <div class="md:col-span-4">
          <label class="label">备份间隔（小时）</label>
          <input
            name="backup_interval_hours"
            type="number"
            min="1"
            class="input"
            value="{{ backup_config.interval_hours }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
        </div>
        <div class="md:col-span-4">
          <label class="label">本地保留份数</label>
          <input
            name="backup_local_retention"
            type="number"
            min="1"
            class="input"
            value="{{ backup_config.local_retention }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
        </div>

        <div class="md:col-span-12">
          <label class="label">本地备份目录</label>
          <input
            name="backup_local_dir"
            class="input"
            value="{{ backup_config.local_dir }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
        </div>
      </div>

      <div class="mt-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <label class="label">忽略集合（不参与备份）</label>
          {% if config_perm['update'] %}
            <div class="flex flex-wrap items-center gap-2">
              <button type="button" class="btn-ghost px-3 py-1 text-xs" x-on:click="toggleExcludedCollections('all')">全选</button>
              <button type="button" class="btn-ghost px-3 py-1 text-xs" x-on:click="toggleExcludedCollections('invert')">反选</button>
              <button type="button" class="btn-ghost px-3 py-1 text-xs" x-on:click="toggleExcludedCollections('none')">清空</button>
            </div>
          {% endif %}
        </div>

        <div x-ref="excludedWrap" class="mt-2 max-h-52 overflow-y-auto rounded-md border border-slate-200 bg-slate-50 p-3">
          {% if collections %}
            <div class="grid gap-2 md:grid-cols-3">
              {% for name in collections %}
                <label class="flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    name="backup_excluded_collections"
                    value="{{ name }}"
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                    {% if name in backup_config.excluded_collections %}checked{% endif %}
                    {% if not config_perm['update'] %}disabled{% endif %}
                  />
                  <span class="truncate">{{ name }}</span>
                </label>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-sm text-slate-500">暂无可选集合。</p>
          {% endif %}
        </div>
      </div>

      <div class="mt-6 border-t border-slate-100 pt-4">
        <div class="grid gap-4 md:grid-cols-12">
          <div class="md:col-span-4">
            <label class="label">云端备份</label>
            <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
              <input
                type="checkbox"
                name="backup_cloud_enabled"
                class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                x-model="cloudEnabled"
                {% if backup_config.cloud_enabled %}checked{% endif %}
                {% if not config_perm['update'] %}disabled{% endif %}
              />
              <span>启用云端备份</span>
            </label>
          </div>
          <div class="md:col-span-4">
            <label class="label">云端保留份数</label>
            <input
              name="backup_cloud_retention"
              type="number"
              min="1"
              class="input"
              value="{{ backup_config.cloud_retention }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
          </div>
          <div class="md:col-span-4">
            <label class="label">云端路径前缀</label>
            <input
              name="backup_cloud_path"
              class="input"
              value="{{ backup_config.cloud_path }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
          </div>
        </div>

        <div class="mt-4" x-show="cloudEnabled" x-cloak>
          <label class="label">备份目标云端</label>
          <p class="mt-1 text-xs text-slate-500">勾选后将显示对应的云端凭证配置，并在保存后自动回显。</p>
          <div class="mt-2 grid gap-3 md:grid-cols-4">
            {% for key, label in cloud_provider_labels.items() %}
              <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
                <input
                  type="checkbox"
                  name="backup_cloud_providers"
                  value="{{ key }}"
                  class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                  x-model="providers"
                  {% if key in backup_config.cloud_providers %}checked{% endif %}
                  {% if not config_perm['update'] %}disabled{% endif %}
                />
                <span>{{ label }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="mt-4 rounded-md border border-slate-200 p-4" x-show="cloudEnabled && hasProvider('aliyun_oss')" x-cloak>
          <h3 class="text-sm font-semibold text-slate-700">
            <i class="fa-solid fa-cloud text-orange-500"></i>
            阿里云 OSS 配置
          </h3>
          <div class="mt-3 grid gap-4 md:grid-cols-12">
            <div class="md:col-span-4">
              <label class="label">Region</label>
              <input
                name="backup_oss_region"
                class="input"
                value="{{ backup_config.oss_region }}"
                placeholder="cn-guangzhou"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-4">
              <label class="label">Endpoint（可选）</label>
              <input
                name="backup_oss_endpoint"
                class="input"
                value="{{ backup_config.oss_endpoint }}"
                placeholder="oss-cn-guangzhou.aliyuncs.com"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-4">
              <label class="label">Bucket</label>
              <input
                name="backup_oss_bucket"
                class="input"
                value="{{ backup_config.oss_bucket }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-6">
              <label class="label">AccessKey ID</label>
              <input
                name="backup_oss_access_key_id"
                class="input"
                value="{{ backup_config.oss_access_key_id }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-6">
              <label class="label">AccessKey Secret</label>
              <input
                name="backup_oss_access_key_secret"
                type="password"
                class="input"
                value="{{ backup_config.oss_access_key_secret }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
          </div>
        </div>

        <div class="mt-4 rounded-md border border-slate-200 p-4" x-show="cloudEnabled && hasProvider('tencent_cos')" x-cloak>
          <h3 class="text-sm font-semibold text-slate-700">
            <i class="fa-solid fa-cloud text-blue-500"></i>
            腾讯云 COS 配置
          </h3>
          <div class="mt-3 grid gap-4 md:grid-cols-12">
            <div class="md:col-span-6">
              <label class="label">Region</label>
              <input
                name="backup_cos_region"
                class="input"
                value="{{ backup_config.cos_region }}"
                placeholder="ap-guangzhou"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-6">
              <label class="label">Bucket</label>
              <input
                name="backup_cos_bucket"
                class="input"
                value="{{ backup_config.cos_bucket }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-6">
              <label class="label">SecretId</label>
              <input
                name="backup_cos_secret_id"
                class="input"
                value="{{ backup_config.cos_secret_id }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-6">
              <label class="label">SecretKey</label>
              <input
                name="backup_cos_secret_key"
                type="password"
                class="input"
                value="{{ backup_config.cos_secret_key }}"
                {% if not config_perm['update'] %}readonly{% endif %}
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card p-5" x-show="configTab === 'cleanup'" x-cloak>
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900">游戏数据清理</h2>
          <p class="text-sm text-slate-500">自动清理已结束的游戏数据，释放存储空间</p>
        </div>
      </div>

      <div class="mt-4 grid gap-4 md:grid-cols-12">
        <div class="md:col-span-4">
          <label class="label">自动清理</label>
          <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
            <input
              type="checkbox"
              name="cleanup_enabled"
              class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
              {% if cleanup_config.enabled %}checked{% endif %}
              {% if not config_perm['update'] %}disabled{% endif %}
            />
            <span>启用自动清理</span>
          </label>
          <p class="text-xs text-slate-500 mt-1">关闭后不会自动清理任何数据</p>
        </div>
        <div class="md:col-span-4">
          <label class="label">数据保留天数</label>
          <input
            name="cleanup_retention_days"
            type="number"
            min="1"
            max="365"
            class="input"
            value="{{ cleanup_config.retention_days }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">已结束的游戏数据保留天数（默认7天）</p>
        </div>
        <div class="md:col-span-4">
          <label class="label">清理间隔（小时）</label>
          <input
            name="cleanup_interval_hours"
            type="number"
            min="1"
            max="168"
            class="input"
            value="{{ cleanup_config.interval_hours }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">自动清理的执行间隔（默认24小时）</p>
        </div>
      </div>

      <div class="mt-6 bg-amber-50 border border-amber-200 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-amber-800 mb-2">
          <i class="fa-solid fa-triangle-exclamation mr-1"></i>清理说明
        </h3>
        <ul class="text-sm text-amber-700 space-y-1 pl-5 list-disc">
          <li>仅清理状态为"已结束"的游戏房间数据</li>
          <li>清理时会同时删除关联的玩家、回合和投票记录</li>
          <li>进行中的游戏数据不会被清理</li>
          <li>清理操作不可恢复，请确保已开启备份功能</li>
        </ul>
      </div>
    </section>

    <section class="card p-5" x-show="configTab === 'game_time'" x-cloak>
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900">游戏阶段时长</h2>
          <p class="text-sm text-slate-500">配置游戏各阶段的时间限制（单位：秒）</p>
        </div>
      </div>

      <div class="mt-4 grid gap-4 md:grid-cols-12">
        <div class="md:col-span-6 lg:col-span-4">
          <label class="label">灵魂注入时长</label>
          <input
            name="setup_duration"
            type="number"
            min="30"
            max="300"
            class="input"
            value="{{ game_time_config.setup_duration }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">游戏开始前准备时间（30-300秒）</p>
        </div>
        <div class="md:col-span-6 lg:col-span-4">
          <label class="label">提问阶段时长</label>
          <input
            name="question_duration"
            type="number"
            min="15"
            max="60"
            class="input"
            value="{{ game_time_config.question_duration }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">提问者输入问题的时间（15-60秒）</p>
        </div>
        <div class="md:col-span-6 lg:col-span-4">
          <label class="label">回答阶段时长</label>
          <input
            name="answer_duration"
            type="number"
            min="20"
            max="90"
            class="input"
            value="{{ game_time_config.answer_duration }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">被测者回答问题的时间（20-90秒）</p>
        </div>
        <div class="md:col-span-6 lg:col-span-4">
          <label class="label">投票阶段时长</label>
          <input
            name="vote_duration"
            type="number"
            min="10"
            max="30"
            class="input"
            value="{{ game_time_config.vote_duration }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">其他玩家投票的时间（10-30秒）</p>
        </div>
        <div class="md:col-span-6 lg:col-span-4">
          <label class="label">结果揭晓延迟</label>
          <input
            name="reveal_delay"
            type="number"
            min="1"
            max="10"
            class="input"
            value="{{ game_time_config.reveal_delay }}"
            {% if not config_perm['update'] %}readonly{% endif %}
          />
          <p class="text-xs text-slate-500 mt-1">回合结果揭晓前的等待时间（1-10秒）</p>
        </div>
      </div>

      <div class="mt-6 rounded-lg border border-slate-200 bg-slate-50 p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h3 class="text-sm font-semibold text-slate-900">角色伪随机保底参数</h3>
            <p class="text-xs text-slate-500 mt-1">用于提问者/被测者选角。参数越大，系统越倾向于补偿历史被抽中次数少的玩家。</p>
          </div>
        </div>

        <div class="mt-4 grid gap-4 md:grid-cols-12">
          <div class="md:col-span-6 lg:col-span-3">
            <label class="label">硬保底触发差值</label>
            <input
              name="role_pity_gap_threshold"
              type="number"
              min="1"
              max="10"
              class="input"
              value="{{ game_role_balance_config.pity_gap_threshold }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
            <p class="text-xs text-slate-500 mt-1">当最高与最低次数差值达到该值时，仅从最低次数池抽取。</p>
          </div>
          <div class="md:col-span-6 lg:col-span-3">
            <label class="label">权重基础值</label>
            <input
              name="role_weight_base"
              type="number"
              min="1"
              max="10000"
              class="input"
              value="{{ game_role_balance_config.weight_base }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
            <p class="text-xs text-slate-500 mt-1">所有候选玩家共有的基础权重。</p>
          </div>
          <div class="md:col-span-6 lg:col-span-3">
            <label class="label">次数差权重增量</label>
            <input
              name="role_weight_deficit_step"
              type="number"
              min="0"
              max="10000"
              class="input"
              value="{{ game_role_balance_config.weight_deficit_step }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
            <p class="text-xs text-slate-500 mt-1">每少 1 次角色经历，额外增加的权重。</p>
          </div>
          <div class="md:col-span-6 lg:col-span-3">
            <label class="label">零次数额外权重</label>
            <input
              name="role_weight_zero_bonus"
              type="number"
              min="0"
              max="10000"
              class="input"
              value="{{ game_role_balance_config.weight_zero_bonus }}"
              {% if not config_perm['update'] %}readonly{% endif %}
            />
            <p class="text-xs text-slate-500 mt-1">从未担任过该角色的玩家额外补偿权重。</p>
          </div>
        </div>
      </div>

      <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-blue-800 mb-2">
          <i class="fa-solid fa-info-circle mr-1"></i>配置说明
        </h3>
        <ul class="text-sm text-blue-700 space-y-1 pl-5 list-disc">
          <li>修改配置后，新创建的房间将使用新的时间设置</li>
          <li>进行中的游戏不受影响，继续沿用创建时的配置</li>
          <li>建议根据玩家群体调整时长，新手可适当延长时间</li>
        </ul>
      </div>
    </section>

    {% if config_perm['update'] %}
      <section class="card p-5">
        <div class="flex justify-end">
          <button type="submit" class="btn-primary">保存设置</button>
        </div>
      </section>
    {% endif %}
  </form>
</div>
{% endblock %}
