{% extends "base.html" %}

{% block content %}
<div class="space-y-4">
  {% set backup_config_perm = request.state.permission_flags.backup_config %}
  {% set backup_records_perm = request.state.permission_flags.backup_records %}
  {% if backup_config_perm['read'] %}
    <form class="space-y-4" method="post" action="/admin/backup">
      <input type="hidden" name="csrf_token" value="{{ request.state.csrf_token or '' }}" />

      <section
        class="card p-5"
        x-data='{
          "cloudEnabled": {{ "true" if config.cloud_enabled else "false" }},
          "providers": {{ config.cloud_providers | tojson }},
          "hasProvider": function(provider) { return this.providers.indexOf(provider) !== -1 },
          "toggleProvider": function(provider) {
            var index = this.providers.indexOf(provider);
            if (index === -1) { this.providers.push(provider) } else { this.providers.splice(index, 1) }
          }
        }'
      >
        <div class="flex items-center justify-between gap-3">
          <div>
            <h1 class="text-lg font-semibold text-slate-900">数据备份</h1>
            <p class="text-sm text-slate-500">配置自动备份策略与云端存储</p>
          </div>
        </div>

        {% if not backup_config_perm['update'] %}
          <div class="mt-4 rounded-md border border-amber-100 bg-amber-50 px-3 py-2 text-sm text-amber-700">
            当前角色仅有查看权限，不能修改备份配置。
          </div>
        {% endif %}

        {% if saved %}
          <div class="mt-4 rounded-md border border-blue-100 bg-blue-50 px-3 py-2 text-sm text-blue-600">
            备份配置已保存。
          </div>
        {% endif %}

        <div class="mt-4 grid gap-4 md:grid-cols-12">
          <div class="md:col-span-4">
            <label class="label">自动备份</label>
            <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
              <input
                type="checkbox"
                name="enabled"
                class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                {% if config.enabled %}checked{% endif %}
                {% if not backup_config_perm['update'] %}disabled{% endif %}
              />
              <span>启用定时备份</span>
            </label>
          </div>
          <div class="md:col-span-4">
            <label class="label">备份间隔（小时）</label>
            <input
              name="interval_hours"
              type="number"
              min="1"
              class="input"
              value="{{ config.interval_hours }}"
              {% if not backup_config_perm['update'] %}readonly{% endif %}
            />
          </div>
          <div class="md:col-span-4">
            <label class="label">本地保留份数</label>
            <input
              name="local_retention"
              type="number"
              min="1"
              class="input"
              value="{{ config.local_retention }}"
              {% if not backup_config_perm['update'] %}readonly{% endif %}
            />
          </div>
          <div class="md:col-span-12">
            <label class="label">本地备份目录</label>
            <input
              name="local_dir"
              class="input"
              value="{{ config.local_dir }}"
              {% if not backup_config_perm['update'] %}readonly{% endif %}
            />
          </div>
        </div>

        <div class="mt-4">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <label class="label">忽略集合（不参与备份）</label>
            {% if backup_config_perm['update'] %}
              <button
                type="button"
                class="btn-ghost px-3 py-1 text-xs"
                hx-get="/admin/backup/collections"
                hx-target="#backup-collections"
                hx-swap="innerHTML"
                hx-indicator="#global-indicator"
              >
                刷新集合
              </button>
            {% endif %}
          </div>
          <div id="backup-collections">
            {% set excluded_collections = config.excluded_collections %}
            {% include "partials/backup_collections.html" %}
          </div>
        </div>

        <div class="mt-6 border-t border-slate-100 pt-4">
          <div class="grid gap-4 md:grid-cols-12">
            <div class="md:col-span-4">
              <label class="label">云端备份</label>
              <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
                <input
                  type="checkbox"
                  name="cloud_enabled"
                  class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                  x-model="cloudEnabled"
                  {% if config.cloud_enabled %}checked{% endif %}
                  {% if not backup_config_perm['update'] %}disabled{% endif %}
                />
                <span>启用云端备份</span>
              </label>
            </div>
            <div class="md:col-span-4">
              <label class="label">云端保留份数</label>
              <input
                name="cloud_retention"
                type="number"
                min="1"
                class="input"
                value="{{ config.cloud_retention }}"
                {% if not backup_config_perm['update'] %}readonly{% endif %}
              />
            </div>
            <div class="md:col-span-4">
              <label class="label">云端路径前缀</label>
              <input
                name="cloud_path"
                class="input"
                value="{{ config.cloud_path }}"
                {% if not backup_config_perm['update'] %}readonly{% endif %}
              />
            </div>
          </div>

          <div class="mt-4" x-show="cloudEnabled" x-cloak>
            <label class="label">备份目标云端</label>
            <div class="mt-2 grid gap-3 md:grid-cols-4">
              {% for key, label in cloud_provider_labels.items() %}
                <label class="flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    name="cloud_providers"
                    value="{{ key }}"
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                    :checked="hasProvider('{{ key }}')"
                    x-on:change="toggleProvider('{{ key }}')"
                    {% if key in config.cloud_providers %}checked{% endif %}
                    {% if not backup_config_perm['update'] %}disabled{% endif %}
                  />
                  <span>{{ label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <div class="mt-4 rounded-md border border-slate-200 p-4" x-show="cloudEnabled && hasProvider('aliyun_oss')" x-cloak>
            <h3 class="text-sm font-semibold text-slate-700">
              <i class="fa-solid fa-cloud text-orange-500"></i>
              阿里云 OSS 配置
            </h3>
            <div class="mt-3 grid gap-4 md:grid-cols-12">
              <div class="md:col-span-4">
                <label class="label">Region</label>
                <input
                  name="oss_region"
                  class="input"
                  value="{{ config.oss_region }}"
                  placeholder="cn-hangzhou"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-4">
                <label class="label">Endpoint（可选）</label>
                <input
                  name="oss_endpoint"
                  class="input"
                  value="{{ config.oss_endpoint }}"
                  placeholder="oss-cn-hangzhou.aliyuncs.com"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-4">
                <label class="label">Bucket</label>
                <input
                  name="oss_bucket"
                  class="input"
                  value="{{ config.oss_bucket }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">AccessKey ID</label>
                <input
                  name="oss_access_key_id"
                  class="input"
                  value="{{ config.oss_access_key_id }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">AccessKey Secret</label>
                <input
                  name="oss_access_key_secret"
                  type="password"
                  class="input"
                  value="{{ config.oss_access_key_secret }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
            </div>
          </div>

          <div class="mt-4 rounded-md border border-slate-200 p-4" x-show="cloudEnabled && hasProvider('tencent_cos')" x-cloak>
            <h3 class="text-sm font-semibold text-slate-700">
              <i class="fa-solid fa-cloud text-blue-500"></i>
              腾讯云 COS 配置
            </h3>
            <div class="mt-3 grid gap-4 md:grid-cols-12">
              <div class="md:col-span-6">
                <label class="label">Region</label>
                <input
                  name="cos_region"
                  class="input"
                  value="{{ config.cos_region }}"
                  placeholder="ap-beijing"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">Bucket</label>
                <input
                  name="cos_bucket"
                  class="input"
                  value="{{ config.cos_bucket }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">SecretId</label>
                <input
                  name="cos_secret_id"
                  class="input"
                  value="{{ config.cos_secret_id }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
              <div class="md:col-span-6">
                <label class="label">SecretKey</label>
                <input
                  name="cos_secret_key"
                  type="password"
                  class="input"
                  value="{{ config.cos_secret_key }}"
                  {% if not backup_config_perm['update'] %}readonly{% endif %}
                />
              </div>
            </div>
          </div>
        </div>

        {% if backup_config_perm['update'] %}
          <div class="mt-4 flex justify-end border-t border-slate-100 pt-4">
            <button type="submit" class="btn-primary">保存配置</button>
          </div>
        {% endif %}
      </section>
    </form>
  {% endif %}

  <section class="card p-5">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-base font-semibold text-slate-900">备份记录</h2>
      {% if backup_records_perm['trigger'] %}
        <button
          type="button"
          class="btn-primary text-sm"
          hx-post="/admin/backup/trigger"
          hx-target="#backup-table-container"
          hx-swap="innerHTML"
          hx-indicator="#global-indicator"
        >
          <i class="fa-solid fa-play mr-1"></i>
          手动备份
        </button>
      {% endif %}
    </div>

    <div id="backup-table-container" class="mt-4">
      {% include "partials/backup_table.html" %}
    </div>
  </section>
</div>
{% endblock %}
